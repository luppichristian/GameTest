name: Win32 Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure CMake
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=Release `
            -DGMT_BUILD_EXAMPLE=ON `
            -DGMT_BUILD_TOOL=ON

      - name: Build
        run: cmake --build build --config Release

      - name: Verify binaries
        run: |
          $game = Get-ChildItem -Path build -Recurse -Filter "GameTest-Game.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          $tool = Get-ChildItem -Path build -Recurse -Filter "GameTest-Tool.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($game -and $tool) { Write-Host "GameTest-Game.exe and GameTest-Tool.exe built successfully" } else { exit 1 }

      - name: Collect release artifacts
        if: github.event_name == 'push'
        run: |
          New-Item -ItemType Directory -Force -Path release | Out-Null
          Copy-Item (Get-ChildItem -Path build -Recurse -Filter "GameTest-Tool.exe" | Select-Object -First 1).FullName -Destination release/
          Copy-Item (Get-ChildItem -Path build -Recurse -Filter "GameTest-Game.exe" | Select-Object -First 1).FullName -Destination release/

      - name: Create or update GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: 1.0.0
          name: Release 1.0.0
          files: release/*.exe
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
